# Purpose
# The system is deployed with deprecated services, weak credentials, exposed
# remote access, and insecure file shares containing sensitive-looking artifacts.
# No exploits or malware are deployed. All weaknesses are configuration-based.
#
# This playbook must not be used in production environments.

- name: Deploy Vulnerable Windows Server (Training Environment)
  hosts: windows
  gather_facts: false
  vars_files:
    - vars/vulnerabilities.yml

  tasks:

  # Task 1
  # Enable SMBv1 which is deprecated and vulnerable
  - name: Enable SMBv1 protocol
    ansible.windows.win_optional_feature:
      name: SMB1Protocol
      state: present
    register: smb1

  # Task 2
  # Reboot system only if SMBv1 installation requires it
  - name: Reboot after SMBv1 install if required
    ansible.windows.win_reboot:
    when: smb1.reboot_required

  # Task 3
  # Create a weak local administrator account
  - name: Create weak local admin user
    ansible.windows.win_user:
      name: "{{ weak_admin_user }}"
      password: "{{ weak_admin_password }}"
      groups:
        - Administrators
      state: present
      password_never_expires: true

  # Task 4
  # Enable the built-in Guest account
  - name: Enable Guest account
    ansible.windows.win_user:
      name: Guest
      enabled: yes
      state: present

  # Task 5
  # Enable Remote Desktop connections
  - name: Enable RDP
    ansible.windows.win_regedit:
      path: HKLM:\System\CurrentControlSet\Control\Terminal Server
      name: fDenyTSConnections
      data: 0
      type: dword

  # Task 6
  # Create the root directory for file shares
  - name: Create file share root directory
    ansible.windows.win_file:
      path: "{{ file_share_root }}"
      state: directory

  # Task 7
  # Create an insecure SMB share with full control for Everyone
  - name: Create insecure SMB share
    ansible.windows.win_share:
      name: "{{ file_share_name }}"
      path: "{{ populate_share_path }}"
      full: Everyone
      state: present

  # Task 8
  # Create cyberpunk-themed subfolders inside the share
  - name: Create cyberpunk folders
    ansible.windows.win_file:
      path: "{{ populate_share_path }}\\{{ item.folder }}"
      state: directory
    loop: "{{ populate }}"

  # Task 9
  # Populate cyberpunk files inside each folder
  - name: Populate cyberpunk files
    ansible.windows.win_copy:
      dest: "{{ populate_share_path }}\\{{ item.0.folder }}\\{{ item.1.name }}"
      content: "{{ item.1.content }}"
    loop: "{{ populate | subelements('files') }}"
