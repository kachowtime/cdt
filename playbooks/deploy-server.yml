- name: Baseline Windows 2022 File Server
  hosts: windows_fileserver
  gather_facts: yes
  become: yes
  become_method: runas
  become_user: Administrator
  vars_files:
    - vars/deploy.yml

  tasks:

    # Task 1: Install the Windows File Server role
    - name: Install File Server role
      ansible.windows.win_feature:
        name: FS-FileServer
        state: present

    # Task 2: Create the root directory for all file shares
    - name: Create root file share directory
      ansible.windows.win_file:
        path: "{{ file_share_root }}"
        state: directory

    # Task 3: Create a Public folder inside the root directory
    - name: Create Public folder
      ansible.windows.win_file:
        path: "{{ file_share_root }}\\{{ file_share_name }}"
        state: directory

    # Task 4: Publish the Public folder as an SMB share
    - name: Create SMB Public share
      ansible.windows.win_share:
        name: "{{ file_share_name }}"
        path: "{{ file_share_root }}\\{{ file_share_name }}"
        description: "{{ file_share_description }}"
        state: present

    # Task 5: Apply NTFS permissions to the Public folder
    - name: Set NTFS permissions on Public share
      ansible.windows.win_acl:
        path: "{{ file_share_root }}\\{{ file_share_name }}"
        user: "{{ file_share_user }}"
        permission: "{{ file_share_permission }}"
        state: present
